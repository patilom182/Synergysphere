{% extends "layout.html" %}
{% block title %}{{ project.name }}{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Project: {{ project.name }}</h2>
        <button id="get-ai-synergy" class="btn btn-lg btn-warning" data-project-id="{{ project.id }}">Get AI Synergy ✨</button>
    </div>

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link active" href="{{ url_for('project_board', project_id=project.id) }}">Kanban Board</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('priority_view', project_id=project.id) }}">AI Priority View</a>
        </li>
    </ul>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header"><h5>Team Members</h5></div>
                <div class="card-body"><ul class="list-group list-group-flush">{% for member in project.members %}<li class="list-group-item">{{ member.username }} ({{member.role}})</li>{% endfor %}</ul></div>
                <div class="card-footer">
                    <form method="POST" action="{{ url_for('invite_user') }}"><input type="hidden" name="project_id" value="{{ project.id }}"><div class="input-group"><input type="text" class="form-control" name="username" placeholder="Invite user by username" required><button class="btn btn-outline-primary" type="submit">Invite</button></div></form>
                </div>
            </div>
        </div>
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header"><h5>Add a New Task</h5></div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('add_task') }}"><input type="hidden" name="project_id" value="{{ project.id }}"><div class="mb-3"><label for="content" class="form-label">Task Description</label><textarea class="form-control" id="content" name="content" required></textarea></div><div class="row"><div class="col-md-6 mb-3"><label for="assignee_id" class="form-label">Assign to</label><select class="form-select" id="assignee_id" name="assignee_id" required><option selected disabled value="">Choose...</option>{% for member in project.members %}<option value="{{ member.id }}">{{ member.username }}</option>{% endfor %}</select></div><div class="col-md-6 mb-3"><label for="due_date" class="form-label">Due Date</label><input type="date" class="form-control" id="due_date" name="due_date" required></div></div><button class="btn btn-primary w-100" type="submit">Add Task</button></form>
                </div>
            </div>
        </div>
    </div>
    <hr class="my-4">
    <div class="kanban-board">
        <div class="kanban-column">
            <h5 class="column-title">To Do</h5>
            {% for task in tasks %}{% if task.status == 'To Do' %}
            <div class="task-card">
                <a href="{{ url_for('task_detail', task_id=task.id) }}" class="task-link"><p>{{ task.content }}</p></a>
                <small class="text-muted">Due: {{ task.due_date.strftime('%Y-%m-%d') if task.due_date }}</small>
                <hr class="my-2"><div class="d-flex justify-content-between align-items-center"><span class="badge bg-primary">{{ task.assignee.username }}</span><form action="{{ url_for('move_task') }}" method="POST" class="m-0"><input type="hidden" name="task_id" value="{{ task.id }}"><input type="hidden" name="new_status" value="In Progress"><button type="submit" class="btn btn-sm btn-outline-primary">Start →</button></form></div>
            </div>
            {% endif %}{% endfor %}
        </div>
        <div class="kanban-column">
            <h5 class="column-title">In Progress</h5>
            {% for task in tasks %}{% if task.status == 'In Progress' %}
             <div class="task-card">
                <a href="{{ url_for('task_detail', task_id=task.id) }}" class="task-link"><p>{{ task.content }}</p></a>
                <small class="text-muted">Due: {{ task.due_date.strftime('%Y-%m-%d') if task.due_date }}</small>
                <hr class="my-2"><div class="d-flex justify-content-between align-items-center"><span class="badge bg-warning text-dark">{{ task.assignee.username }}</span><div><form action="{{ url_for('move_task') }}" method="POST" class="d-inline-block"><input type="hidden" name="task_id" value="{{ task.id }}"><input type="hidden" name="new_status" value="To Do"><button type="submit" class="btn btn-sm btn-outline-secondary">←</button></form><form action="{{ url_for('move_task') }}" method="POST" class="d-inline-block"><input type="hidden" name="task_id" value="{{ task.id }}"><input type="hidden" name="new_status" value="Done"><button type="submit" class="btn btn-sm btn-outline-success">→</button></form></div></div>
            </div>
            {% endif %}{% endfor %}
        </div>
        <div class="kanban-column">
            <h5 class="column-title">Done</h5>
            {% for task in tasks %}{% if task.status == 'Done' %}
            <div class="task-card done">
                <a href="{{ url_for('task_detail', task_id=task.id) }}" class="task-link"><p><del>{{ task.content }}</del></p></a>
                <small class="text-muted">Completed</small>
                <hr class="my-2"><div class="d-flex justify-content-between align-items-center"><span class="badge bg-success">{{ task.assignee.username }}</span><form action="{{ url_for('move_task') }}" method="POST" class="m-0"><input type="hidden" name="task_id" value="{{ task.id }}"><input type="hidden" name="new_status" value="In Progress"><button type="submit" class="btn btn-sm btn-outline-danger">Re-open</button></form></div>
            </div>
            {% endif %}{% endfor %}
        </div>
    </div>
</div>

<div class="modal fade" id="aiSynergyModal" tabindex="-1" aria-labelledby="aiSynergyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="aiSynergyModalLabel">✨ AI Synergy Analysis</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><div id="ai-result-content"><p class="text-center">Analyzing project...</p></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div>
</div>
{% endblock %}